#include "mainwindow.h"
#include "ui_mainwindow.h"
#include "chartviewer.h"
#include "dataeditor.h"
#include "statisticsworker.h"

#include <QFileDialog>
#include <QMessageBox>
#include <QDir>
#include <QFile>
#include <QTextStream>
#include <QVBoxLayout>
#include <QProcess>
#include <QPixmap>
#include <fstream>
#include <sstream>
#include <algorithm>
#include <numeric>
#include <cmath>

MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
    , ui(new Ui::MainWindow)
    , worker(nullptr)
    , currentAnalysisType(MLE_NORMAL)
{
    ui->setupUi(this);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤
    setupUI();
    setupConnections();

    // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
    updateFileList();

    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
    statusBar()->showMessage("–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ");
}

MainWindow::~MainWindow()
{
    if (worker) {
        worker->quit();
        worker->wait();
        delete worker;
    }
    delete ui;
}

/**
 * @brief –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
 */
void MainWindow::setupUI()
{
    // –°–æ–∑–¥–∞—Ç—å –≤–∏–¥–∂–µ—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    chartViewer = new ChartViewer(this);
    QVBoxLayout* chartLayout = new QVBoxLayout(ui->chartContainer);
    chartLayout->addWidget(chartViewer);
    ui->chartContainer->setLayout(chartLayout);

    // –°–æ–∑–¥–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–∞–Ω–Ω—ã—Ö
    dataEditor = new DataEditor(this);
    QVBoxLayout* editorLayout = new QVBoxLayout(ui->editorContainer);
    editorLayout->addWidget(dataEditor);
    ui->editorContainer->setLayout(editorLayout);

    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    ui->alphaSpinBox->setValue(0.05);
    ui->progressBar->setValue(0);
    ui->progressBar->setVisible(false);

    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —à—Ä–∏—Ñ—Ç –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    QFont monoFont("Courier", 10);
    ui->resultsText->setFont(monoFont);
    ui->fileContentText->setFont(monoFont);
}

/**
 * @brief –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ —Å–ª–æ—Ç–æ–≤
 */
void MainWindow::setupConnections()
{
    // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    connect(ui->runButton, &QPushButton::clicked, this, &MainWindow::onRunAnalysis);
    connect(ui->clearButton, &QPushButton::clicked, this, &MainWindow::onClearResults);
    connect(ui->saveButton, &QPushButton::clicked, this, &MainWindow::onSaveResults);
    connect(ui->loadDataButton, &QPushButton::clicked, this, &MainWindow::onLoadData);

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ –∞–Ω–∞–ª–∏–∑–∞
    connect(ui->analysisTypeCombo, QOverload<int>::of(&QComboBox::currentIndexChanged),
            this, &MainWindow::onAnalysisTypeChanged);

    // –í—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤
    connect(ui->inputFilesList, &QListWidget::currentTextChanged,
            this, &MainWindow::onInputFileSelected);
    connect(ui->outputFilesList, &QListWidget::currentTextChanged,
            this, &MainWindow::onOutputFileSelected);

    // –†–µ–¥–∞–∫—Ç–æ—Ä –¥–∞–Ω–Ω—ã—Ö
    connect(dataEditor, &DataEditor::dataChanged, [this]() {
        statusBar()->showMessage("–î–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω—ã", 2000);
    });

    // –ú–µ–Ω—é
    connect(ui->actionOpen, &QAction::triggered, this, &MainWindow::onLoadData);
    connect(ui->actionSave, &QAction::triggered, this, &MainWindow::onSaveResults);
    connect(ui->actionQuit, &QAction::triggered, this, &QWidget::close);
    connect(ui->actionAbout, &QAction::triggered, [this]() {
        QMessageBox::about(this, "–û –ø—Ä–æ–≥—Ä–∞–º–º–µ",
            "–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ - –ú–µ—Ç–æ–¥—ã –ê–≥–∞–º–∏—Ä–æ–≤–∞\n\n"
            "–í–µ—Ä—Å–∏—è 1.0\n\n"
            "–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–µ—Ç–æ–¥—ã:\n"
            "‚Ä¢ MLE/MLS –æ—Ü–µ–Ω–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤\n"
            "‚Ä¢ –ö—Ä–∏—Ç–µ—Ä–∏–π –ì—Ä–∞–±–±—Å–∞\n"
            "‚Ä¢ F-–∫—Ä–∏—Ç–µ—Ä–∏–π –§–∏—à–µ—Ä–∞\n"
            "‚Ä¢ t-–∫—Ä–∏—Ç–µ—Ä–∏–π –°—Ç—å—é–¥–µ–Ω—Ç–∞\n"
            "‚Ä¢ –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã\n\n"
            "ü§ñ Generated with Claude Code");
    });
}

/**
 * @brief –ó–∞–ø—É—Å–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
 */
void MainWindow::onRunAnalysis()
{
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
    if (currentData.empty()) {
        showError("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –∞–Ω–∞–ª–∏–∑–∞");
        return;
    }

    // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    ui->runButton->setEnabled(false);
    ui->progressBar->setVisible(true);
    ui->progressBar->setValue(0);

    statusBar()->showMessage("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑...");

    // –°–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫
    if (worker) {
        worker->quit();
        worker->wait();
        delete worker;
    }

    worker = new StatisticsWorker(this);
    worker->setData(currentData);
    worker->setAlpha(ui->alphaSpinBox->value());

    // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –∑–∞–¥–∞—á–∏
    int analysisIndex = ui->analysisTypeCombo->currentIndex();
    StatisticsWorker::TaskType task;

    switch (analysisIndex) {
        case 0: task = StatisticsWorker::TASK_MLE_NORMAL; break;
        case 1: task = StatisticsWorker::TASK_MLE_WEIBULL; break;
        case 2: task = StatisticsWorker::TASK_MLS_NORMAL; break;
        case 3: task = StatisticsWorker::TASK_GRUBBS; break;
        case 4: task = StatisticsWorker::TASK_FISHER; break;
        case 5: task = StatisticsWorker::TASK_STUDENT_AUTO; break;
        case 6: task = StatisticsWorker::TASK_CONFIDENCE_INTERVALS; break;
        case 7: task = StatisticsWorker::TASK_PERCENTILES; break;
        default: task = StatisticsWorker::TASK_MLE_NORMAL;
    }

    worker->setTask(task);

    // –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã
    connect(worker, &StatisticsWorker::progressUpdated, this, &MainWindow::onProgressUpdated);
    connect(worker, &StatisticsWorker::finished, this, &MainWindow::onAnalysisFinished);
    connect(worker, &StatisticsWorker::resultsReady, this, &MainWindow::onResultsReady);

    // –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Ç–æ–∫
    worker->start();
}

/**
 * @brief –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
 */
void MainWindow::onClearResults()
{
    ui->resultsText->clear();
    ui->fileContentText->clear();
    chartViewer->clearChart();
    ui->progressBar->setValue(0);
    statusBar()->showMessage("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã", 2000);
}

/**
 * @brief –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
 */
void MainWindow::onSaveResults()
{
    QString fileName = QFileDialog::getSaveFileName(this,
        "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", "output",
        "Text files (*.txt);;All files (*)");

    if (!fileName.isEmpty()) {
        QFile file(fileName);
        if (file.open(QIODevice::WriteOnly | QIODevice::Text)) {
            QTextStream out(&file);
            out << ui->resultsText->toPlainText();
            file.close();
            showSuccess("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ " + fileName);
        } else {
            showError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª");
        }
    }
}

/**
 * @brief –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞
 */
void MainWindow::onLoadData()
{
    QString fileName = QFileDialog::getOpenFileName(this,
        "–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö", "../input",
        "Data files (*.txt);;All files (*)");

    if (!fileName.isEmpty()) {
        currentData = loadDataFromFile(fileName);
        if (!currentData.empty()) {
            currentInputFile = fileName;

            // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            double sum = std::accumulate(currentData.begin(), currentData.end(), 0.0);
            double mean = sum / currentData.size();

            double variance = 0.0;
            for (double x : currentData) {
                variance += (x - mean) * (x - mean);
            }
            variance /= currentData.size();
            double std_dev = std::sqrt(variance);

            double min_val = *std::min_element(currentData.begin(), currentData.end());
            double max_val = *std::max_element(currentData.begin(), currentData.end());

            QString stats = QString(
                "–†–∞–∑–º–µ—Ä: %1\n"
                "–°—Ä–µ–¥–Ω–µ–µ: %2\n"
                "–°–ö–û: %3\n"
                "–ú–∏–Ω: %4\n"
                "–ú–∞–∫—Å: %5"
            ).arg(currentData.size())
             .arg(mean, 0, 'f', 4)
             .arg(std_dev, 0, 'f', 4)
             .arg(min_val, 0, 'f', 4)
             .arg(max_val, 0, 'f', 4);

            ui->statsText->setPlainText(stats);

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
            dataEditor->setData(currentData);

            showSuccess(QString("–ó–∞–≥—Ä—É–∂–µ–Ω–æ %1 –∑–Ω–∞—á–µ–Ω–∏–π").arg(currentData.size()));
        }
    }
}

/**
 * @brief –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
 */
std::vector<double> MainWindow::loadDataFromFile(const QString& fileName)
{
    std::vector<double> data;
    QFile file(fileName);

    if (file.open(QIODevice::ReadOnly | QIODevice::Text)) {
        QTextStream in(&file);
        while (!in.atEnd()) {
            QString line = in.readLine().trimmed();
            if (!line.isEmpty() && !line.startsWith("#")) {
                bool ok;
                double value = line.toDouble(&ok);
                if (ok) {
                    data.push_back(value);
                }
            }
        }
        file.close();
    } else {
        showError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª: " + fileName);
    }

    return data;
}

/**
 * @brief –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞
 */
void MainWindow::onAnalysisFinished(bool success)
{
    ui->runButton->setEnabled(true);
    ui->progressBar->setVisible(false);

    if (success) {
        statusBar()->showMessage("–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ", 3000);
        ui->tabWidget->setCurrentIndex(0); // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    } else {
        statusBar()->showMessage("–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω —Å –æ—à–∏–±–∫–∞–º–∏", 3000);
    }
}

/**
 * @brief –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
 */
void MainWindow::onProgressUpdated(int value, const QString& message)
{
    ui->progressBar->setValue(value);
    statusBar()->showMessage(message);
}

/**
 * @brief –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
 */
void MainWindow::onResultsReady(const QString& results)
{
    ui->resultsText->setPlainText(results);

    // –í—ã–∑–≤–∞—Ç—å Python —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
    QString rootPath = getProjectRootPath();
    QString pythonScript;
    QString plotFile;

    switch (currentAnalysisType) {
        case MLE_NORMAL:
            pythonScript = rootPath + "/python/plot_normal.py";
            plotFile = rootPath + "/output/plot_mle_normal.png";
            QProcess::execute("python3", QStringList() << pythonScript << "mle");
            break;
        case MLE_WEIBULL:
            pythonScript = rootPath + "/python/plot_weibull.py";
            plotFile = rootPath + "/output/plot_mle_weibull.png";
            QProcess::execute("python3", QStringList() << pythonScript << "mle");
            break;
        case MLS_NORMAL:
            pythonScript = rootPath + "/python/plot_normal.py";
            plotFile = rootPath + "/output/plot_mls_normal.png";
            QProcess::execute("python3", QStringList() << pythonScript << "mls");
            break;
        default:
            // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
            if (!currentData.empty() && chartViewer) {
                chartViewer->showHistogram(currentData, "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö");
            }
            break;
    }

    // –ï—Å–ª–∏ –±—ã–ª —Å–æ–∑–¥–∞–Ω Python –≥—Ä–∞—Ñ–∏–∫ - –ø–æ–∫–∞–∑–∞—Ç—å –µ–≥–æ
    if (!plotFile.isEmpty() && QFile::exists(plotFile)) {
        QPixmap plot(plotFile);
        if (!plot.isNull()) {
            chartViewer->showImage(plot);
        }
    }

    // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    updateFileList();
}

/**
 * @brief –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ –∞–Ω–∞–ª–∏–∑–∞
 */
void MainWindow::onAnalysisTypeChanged(int index)
{
    currentAnalysisType = static_cast<AnalysisType>(index);

    // –î–ª—è —Ç–µ—Å—Ç–æ–≤ —Å –¥–≤—É–º—è –≤—ã–±–æ—Ä–∫–∞–º–∏ –Ω—É–∂–Ω–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    if (index == 4 || index == 5) {  // Fisher –∏–ª–∏ Student
        statusBar()->showMessage("–î–ª—è —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–≤–µ –≤—ã–±–æ—Ä–∫–∏", 3000);
    }
}

/**
 * @brief –í—ã–±–æ—Ä –≤—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
 */
void MainWindow::onInputFileSelected(const QString& fileName)
{
    if (!fileName.isEmpty()) {
        QString fullPath = getProjectRootPath() + "/input/" + fileName;
        currentData = loadDataFromFile(fullPath);

        if (dataEditor) {
            dataEditor->setData(currentData);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        if (!currentData.empty()) {
            double sum = std::accumulate(currentData.begin(), currentData.end(), 0.0);
            double mean = sum / currentData.size();
            double sq_sum = std::accumulate(currentData.begin(), currentData.end(), 0.0,
                [mean](double acc, double val) { return acc + (val - mean) * (val - mean); });
            double variance = sq_sum / (currentData.size() - 1);
            double std_dev = std::sqrt(variance);

            QString stats = QString("n = %1\n–°—Ä–µ–¥–Ω–µ–µ: %2\n–°–ö–û: %3\n–ú–∏–Ω: %4\n–ú–∞–∫—Å: %5")
                .arg(currentData.size())
                .arg(mean, 0, 'f', 4)
                .arg(std_dev, 0, 'f', 4)
                .arg(*std::min_element(currentData.begin(), currentData.end()), 0, 'f', 4)
                .arg(*std::max_element(currentData.begin(), currentData.end()), 0, 'f', 4);

            ui->statsText->setPlainText(stats);
            statusBar()->showMessage(QString("–ó–∞–≥—Ä—É–∂–µ–Ω–æ %1 –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ %2")
                .arg(currentData.size()).arg(fileName), 3000);
        }
    }
}

/**
 * @brief –í—ã–±–æ—Ä –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
 */
void MainWindow::onOutputFileSelected(const QString& fileName)
{
    if (!fileName.isEmpty()) {
        QString fullPath = getProjectRootPath() + "/output/" + fileName;

        // –ï—Å–ª–∏ —ç—Ç–æ PNG —Ñ–∞–π–ª - –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if (fileName.endsWith(".png", Qt::CaseInsensitive)) {
            QPixmap pixmap(fullPath);
            if (!pixmap.isNull()) {
                // –ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ –≤–∫–ª–∞–¥–∫–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
                chartViewer->showImage(pixmap);
                ui->tabWidget->setCurrentIndex(1); // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É –≥—Ä–∞—Ñ–∏–∫–æ–≤
                ui->fileContentText->setPlainText("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫–µ '–ì—Ä–∞—Ñ–∏–∫–∏'");
            } else {
                ui->fileContentText->setPlainText("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
            }
        } else {
            // –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª - –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            QFile file(fullPath);
            if (file.open(QIODevice::ReadOnly | QIODevice::Text)) {
                QTextStream in(&file);
                ui->fileContentText->setPlainText(in.readAll());
                file.close();
            }
        }
    }
}

/**
 * @brief –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
 */
QString MainWindow::getProjectRootPath() const
{
    // GUI –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ /path/to/alg2/gui/build
    // –ù—É–∂–Ω–æ –ø–æ–¥–Ω—è—Ç—å—Å—è –Ω–∞ 2 —É—Ä–æ–≤–Ω—è –≤–≤–µ—Ä—Ö –¥–æ /path/to/alg2
    QDir buildDir = QDir::current();
    buildDir.cdUp();  // –∏–∑ build –≤ gui
    buildDir.cdUp();  // –∏–∑ gui –≤ alg2
    return buildDir.absolutePath();
}

void MainWindow::updateFileList()
{
    QString rootPath = getProjectRootPath();

    // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    ui->inputFilesList->clear();
    QDir inputDir(rootPath + "/input");
    if (inputDir.exists()) {
        QStringList inputFiles = inputDir.entryList(QStringList() << "*.txt", QDir::Files);
        ui->inputFilesList->addItems(inputFiles);
    }

    // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    ui->outputFilesList->clear();
    QDir outputDir(rootPath + "/output");
    if (outputDir.exists()) {
        QStringList outputFiles = outputDir.entryList(QStringList() << "*.txt" << "*.png", QDir::Files);
        ui->outputFilesList->addItems(outputFiles);

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if (outputFiles.isEmpty()) {
            statusBar()->showMessage("–ù–µ—Ç –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤", 2000);
        } else {
            statusBar()->showMessage(QString("–ù–∞–π–¥–µ–Ω–æ %1 –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤").arg(outputFiles.size()), 2000);
        }
    }
}

/**
 * @brief –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
 */
void MainWindow::showError(const QString& message)
{
    QMessageBox::critical(this, "–û—à–∏–±–∫–∞", message);
    statusBar()->showMessage("–û—à–∏–±–∫–∞: " + message, 5000);
}

/**
 * @brief –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
 */
void MainWindow::showSuccess(const QString& message)
{
    statusBar()->showMessage(message, 3000);
}

void MainWindow::onEditData()
{
    // TODO: implement
}

void MainWindow::onShowFiles()
{
    updateFileList();
    statusBar()->showMessage("–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω", 2000);
}

void MainWindow::onShowChart()
{
    chartViewer->showHistogram(currentData, "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö");
}

void MainWindow::onExportChart()
{
    QString fileName = QFileDialog::getSaveFileName(this, "–≠–∫—Å–ø–æ—Ä—Ç –≥—Ä–∞—Ñ–∏–∫–∞", "chart.png", "PNG Images (*.png)");
    if (!fileName.isEmpty()) {
        chartViewer->exportToPNG(fileName);
    }
}

void MainWindow::onDistributionChanged(int)
{
    // TODO: implement
}
