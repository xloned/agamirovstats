#ifndef SHAPIRO_WILK_H
#define SHAPIRO_WILK_H

#include <vector>
#include <string>

/**
 * @brief Результат критерия Шапиро-Уилка для проверки нормальности
 *
 * Критерий используется для проверки гипотезы о том, что выборка
 * получена из нормального распределения (порядковые статистики,
 * раздел 3.8.1, формулы 3.17-3.19)
 */
struct ShapiroWilkResult {
    double w_statistic;        // Значение статистики W (0 < W ≤ 1)
    double critical_value;     // Критическое значение из таблицы
    double p_value;            // Приблизительное p-значение (если возможно вычислить)
    bool reject_h0;            // true, если отвергаем H0: данные из нормального распределения

    size_t n;                  // Размер выборки
    double alpha;              // Уровень значимости

    // Вспомогательные величины для вычислений
    double numerator;          // b² - числитель формулы W
    double denominator;        // s² - знаменатель формулы W (сумма квадратов отклонений)
};

/**
 * @brief Критерий Шапиро-Уилка для проверки нормальности распределения
 *
 * Проверяет гипотезу H0: выборка получена из нормального распределения
 * против H1: выборка не является нормальной
 *
 * Статистика (формула 3.17 из порядковых статистик):
 * W = b² / s²
 *
 * где:
 * - b = Σᵢ aᵢ x(i) - линейная комбинация порядковых статистик (формула 3.18)
 * - s² = Σᵢ(xᵢ - x̄)² - сумма квадратов отклонений от среднего (формула 3.19)
 * - aᵢ - коэффициенты, зависящие от n (берутся из таблиц или вычисляются)
 * - x(i) - i-я порядковая статистика (i-е по величине значение)
 *
 * Свойства статистики W:
 * - 0 < W ≤ 1
 * - Чем ближе W к 1, тем лучше согласие с нормальным распределением
 * - Малые значения W указывают на отклонение от нормальности
 *
 * @param data Выборка данных для проверки на нормальность
 * @param alpha Уровень значимости (по умолчанию 0.05)
 * @return Результат теста с подробной информацией
 *
 * Применимость:
 * - Размер выборки: 3 ≤ n ≤ 5000 (оптимально для малых выборок n < 50)
 * - Тест особенно чувствителен к выбросам
 * - Для n > 50 рекомендуется также использовать графические методы
 *
 * Примечание:
 * Коэффициенты aᵢ вычисляются на основе математических ожиданий порядковых
 * статистик стандартного нормального распределения. В данной реализации
 * используется приближенная формула для вычисления коэффициентов.
 */
ShapiroWilkResult shapiro_wilk_test(const std::vector<double>& data,
                                    double alpha = 0.05);

/**
 * @brief Вывод результатов критерия Шапиро-Уилка в консоль и файл
 *
 * @param result Результат теста Шапиро-Уилка
 * @param filename Имя файла для сохранения (если пустое, выводится только в консоль)
 */
void print_shapiro_wilk_result(const ShapiroWilkResult& result,
                               const std::string& filename = "");

#endif // SHAPIRO_WILK_H
