#ifndef WILCOXON_RANKSUM_H
#define WILCOXON_RANKSUM_H

#include <vector>
#include <string>

/**
 * @brief Результат критерия ранга суммы Уилкоксона (Wilcoxon rank-sum test)
 *
 * Непараметрический критерий для проверки гипотезы о равенстве распределений
 * двух независимых выборок (порядковые статистики, раздел 3.9.4, формулы 3.32-3.35)
 *
 * Также известен как критерий Манна-Уитни (Mann-Whitney U test)
 */
struct WilcoxonRankSumResult {
    double w_statistic;        // Статистика W (сумма рангов первой выборки)
    double u_statistic;        // Статистика U Манна-Уитни
    double z_statistic;        // Z-статистика для больших выборок
    double critical_value;     // Критическое значение
    double p_value;            // P-значение двустороннего теста
    bool reject_h0;            // true, если отвергаем H0: F₁(x) = F₂(x)

    size_t n1;                 // Размер первой выборки
    size_t n2;                 // Размер второй выборки
    size_t total_n;            // Общее количество наблюдений (n₁ + n₂)

    double mean_w;             // Математическое ожидание W под H0
    double std_w;              // Стандартное отклонение W под H0

    bool use_normal_approx;    // true, если использовано нормальное приближение
    size_t num_ties;           // Количество связанных рангов (ties)
    double tie_correction;     // Поправка на связи

    double alpha;              // Уровень значимости
};

/**
 * @brief Критерий ранга суммы Уилкоксона (Wilcoxon rank-sum test)
 *
 * Проверяет гипотезу H0: F₁(x) = F₂(x) (распределения одинаковы)
 * против H1: F₁(x) ≠ F₂(x) (распределения различаются)
 *
 * Алгоритм (формулы 3.32-3.35 из порядковых статистик):
 * 1. Объединяем обе выборки и ранжируем все наблюдения
 * 2. Вычисляем сумму рангов первой выборки:
 *    W = Σᵢ Rᵢ, где Rᵢ - ранг i-го наблюдения из первой выборки (формула 3.32)
 *
 * 3. Для малых выборок (n₁, n₂ ≤ 20) используются точные таблицы
 *
 * 4. Для больших выборок используется нормальное приближение (формула 3.33):
 *    - E[W] = n₁(n₁ + n₂ + 1) / 2
 *    - Var[W] = n₁n₂(n₁ + n₂ + 1) / 12
 *    - Z = (W - E[W]) / √Var[W]
 *    - При наличии связей применяется поправка (формула 3.34-3.35)
 *
 * Связь с U-статистикой Манна-Уитни:
 * U₁ = W - n₁(n₁ + 1) / 2
 * U₂ = n₁n₂ - U₁
 * U = min(U₁, U₂)
 *
 * @param data1 Первая выборка
 * @param data2 Вторая выборка
 * @param alpha Уровень значимости (по умолчанию 0.05)
 * @return Результат теста с подробной информацией
 *
 * Применимость:
 * - Непараметрический тест (не требует нормальности)
 * - Выборки независимы
 * - Данные измерены как минимум в порядковой шкале
 * - Для малых выборок (n₁, n₂ < 10) точность может быть низкой
 *
 * Преимущества:
 * - Устойчив к выбросам
 * - Не требует нормальности распределения
 * - Мощность близка к t-тесту при нормальных данных (эффективность ~95%)
 */
WilcoxonRankSumResult wilcoxon_ranksum_test(const std::vector<double>& data1,
                                             const std::vector<double>& data2,
                                             double alpha = 0.05);

/**
 * @brief Вывод результатов критерия Уилкоксона в консоль и файл
 *
 * @param result Результат теста Уилкоксона
 * @param filename Имя файла для сохранения (если пустое, выводится только в консоль)
 */
void print_wilcoxon_ranksum_result(const WilcoxonRankSumResult& result,
                                   const std::string& filename = "");

#endif // WILCOXON_RANKSUM_H
